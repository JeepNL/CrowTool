@using System.Timers
@inherits LayoutComponentBase
@inject HttpClient Http
@inject IConfiguration Config
@inject NavigationManager NavMan
@inject StateContainerService StateContainer
@inject ISyncLocalStorageService LocalStorage
@inject BaseLayerLuminance BaseLayerLuminance
@implements IDisposable

<PageTitle>CrowTool</PageTitle>

<div class="container" @ref="container">
    <div class="siteheader">
        <div class="headerleft">
            <h1><a href="#">CrowTool</a></h1>
        </div>
        <div class="headerright">
            <FluentSwitch @onchange=SwitchTheme>
                <span style="padding-inline-end: 2px;"><b>Theme</b></span>
                <span slot="unchecked-message"><b>Dark</b></span>
                <span slot="checked-message"><b>Light</b></span>
            </FluentSwitch>
        </div>
        @*<a href="https://docs.microsoft.com/aspnet/" target="_blank">About</a>*@
    </div>
    <div class="main">

        @*
        <div class="navigation">
        <NavMenu />
        </div>
        *@

        <div class="content">
            <main>
                <article class="content px-4">
                    <ErrorBoundary @ref="errorBoundary">
                        <ChildContent>
                            @if (!tokenExpired)
                            {
                                @Body
                            }
                        </ChildContent>
                        <ErrorContent Context="ex">
                            <p class="error">@ex.Message</p>
                        </ErrorContent>
                    </ErrorBoundary>
                    <Footer></Footer>
                </article>
            </main>
        </div>
    </div>
</div>


@code {
    BrowserStorage? bStorage;

    ElementReference container;
    ErrorBoundary? errorBoundary;
    float baseLayerLuminance = 0.15f;

    private Timer? timer;
    bool tokenExpired = false;
    int minutesToExpire = 3;
    int minutesToCheck = 2;

    protected override async Task OnInitializedAsync()
    {
        StateContainer.OnChange += StateContainerChanged;

        bStorage = LocalStorage.GetItem<BrowserStorage>("b_stor");
        if (bStorage != null && !string.IsNullOrEmpty(bStorage.Val))
        {
            byte[] bytes = Convert.FromBase64String(bStorage.Val);
            StateContainer.UserInfo = JsonSerializer.Deserialize<TwitterLoginResponse>(bytes)!;

            // check if token has expired for returning user
            long ticksLeft = StateContainer.UserInfo.ExpiresInTicks - DateTime.UtcNow.Ticks;
            TimeSpan expires = new TimeSpan(ticksLeft);

            if (expires.TotalMinutes <= minutesToExpire)
            {
                tokenExpired = true;
                await RefreshTokens();
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await BaseLayerLuminance.SetValueFor(container, baseLayerLuminance);

        if (firstRender)
        {
            // always start timer at first render
            if (timer is null)
            {
                Console.WriteLine("Init.");
                timer = new Timer(1000 * 60 * minutesToCheck); // check every x minutes
                timer.Elapsed += (sender, eventArgs) => OnTimerCallback();
                timer.Enabled = true;
                timer.Start();
            }
        }
    }

    protected override void OnParametersSet()
    {
        errorBoundary?.Recover();
    }

    private void OnTimerCallback() // for expired token
    {
        _ = InvokeAsync(async () =>
        {
            if (StateContainer.UserInfo.UserId != 0) // user logged in.
            {
                // #TODO CHECK TICKS LEFT, if someone edited localstorage, delete localstorage
                Console.WriteLine("Token Check.");
                long ticksLeft = StateContainer.UserInfo.ExpiresInTicks - DateTime.UtcNow.Ticks;
                TimeSpan expires = new TimeSpan(ticksLeft);
                if (expires.TotalMinutes <= minutesToExpire)
                    await RefreshTokens();
            }
        });
    }

    public async Task RefreshTokens()
    {
        RefreshRequestResponse? refreshRequestResponse = new()
            {
                AccessToken = StateContainer.UserInfo.AccessToken,
                RefreshToken = StateContainer.UserInfo.RefreshToken
            };

        Console.WriteLine("Refreshing Token.");

        string? PostToBackEndApiUrl = $"https://{Config["BackEndUrl"]}/OAuth2/Refresh";
        HttpResponseMessage? responseMessage = await Http.PostAsJsonAsync(PostToBackEndApiUrl, refreshRequestResponse);

        if (responseMessage.IsSuccessStatusCode)
        {
            refreshRequestResponse = await responseMessage.Content.ReadFromJsonAsync<RefreshRequestResponse>();

            if (refreshRequestResponse?.ExpiresIn == Helpers.TwitterExpiresInSeconds)
            {
                StateContainer.UserInfo.AccessToken = refreshRequestResponse.AccessToken;
                StateContainer.UserInfo.RefreshToken = refreshRequestResponse.RefreshToken;
                StateContainer.UserInfo.ExpiresInTicks = DateTime.UtcNow.AddSeconds(refreshRequestResponse.ExpiresIn).Ticks;

                BinaryData jsonData = BinaryData.FromObjectAsJson(StateContainer.UserInfo, Helpers.JsonSeriOptions());
                string jsonDataBase64 = Convert.ToBase64String(jsonData);
                bStorage!.Val = jsonDataBase64;
                LocalStorage.SetItem<BrowserStorage>("b_stor", bStorage);
                tokenExpired = false;

                //// #TODO Get Me! - User may have changed his UserName, Handle (Name) and/or ProfileImage, new call to 👇
                //TwitterContext twitterCtx = new(auth);
                //TwitterUserQuery? response = await (
                //	from usr in twitterCtx.TwitterUser
                //	where usr.Type == UserType.Me
                //	select usr
                //).SingleOrDefaultAsync();
            }
        }
        else // BadRequest
        {
            string resp = await responseMessage.Content.ReadAsStringAsync();
            if (resp == "ReInit")
            {
                Console.WriteLine("Couldn't refresh tokens, please log in again ...");
                StateContainer.UserInfo.UserId = 0;
                StateContainer.UserInfo.Name = "";
                tokenExpired = false;
                await InvokeAsync(StateHasChanged);
            }
            //// TODO
            //else if (resp == "Connection")
            //{

            //}
        }
    }

    public void SwitchTheme()
    {
        baseLayerLuminance = baseLayerLuminance == 1f ? 0.15f : 1f;
    }

    public void Dispose()
    {
        timer?.Dispose();
        StateContainer.OnChange -= StateHasChanged;
    }

    private void StateContainerChanged()
    {
        StateHasChanged();
    }
}
